<!doctype html>
<html lang="en">
<head>
<script>
    if (localStorage.getItem('usjobsearch_auth_v1') !== 'true') {
        window.location.href = 'index.html';
    }
</script>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>AI Job Match & Tailor</title>
<style>
  * { box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; line-height: 1.6; background: #f6f8fa; color: #24292f; margin: 0; }
  .header { background: #fff; border-bottom: 1px solid #d0d7de; padding: 16px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
  .logo { font-weight: bold; font-size: 18px; display: flex; align-items: center; gap: 8px; }
  .btn { 
    display: inline-flex; align-items: center; justify-content: center; gap: 8px; 
    padding: 8px 16px; border-radius: 6px; border: 1px solid rgba(27,31,36,0.15); 
    background-color: #f6f8fa; color: #24292f; font-size: 14px; font-weight: 600; 
    line-height: 20px; white-space: nowrap; vertical-align: middle; cursor: pointer; 
    user-select: none; appearance: none; text-decoration: none; 
    transition: 0.2s cubic-bezier(0.3, 0, 0.5, 1); 
    box-shadow: 0 1px 0 rgba(27,31,36,0.04); 
  }
  .btn:hover { background-color: #f3f4f6; text-decoration: none; transition-duration: 0.1s; }
  .btn:active { background-color: #ebecf0; box-shadow: inset 0 1px 0 rgba(208,215,222,0.2); }
  
  .btn.primary { 
    background-color: #0969da; color: #fff; border-color: rgba(27,31,36,0.15); 
    box-shadow: 0 1px 0 rgba(27,31,36,0.1); 
  }
  .btn.primary:hover { background-color: #0860ca; }
  .btn.primary:active { box-shadow: inset 0 1px 0 rgba(0,0,0,0.2); }
  .btn.primary:disabled { background-color: #80ccff; cursor: not-allowed; border-color: transparent; }
  
  .container { max-width: 1400px; margin: 0 auto; display: flex; height: calc(100vh - 65px); }
  
  /* Sidebar - Job Feed */
  .sidebar { width: 350px; background: #fff; border-right: 1px solid #d0d7de; display: flex; flex-direction: column; }
  .sidebar-header { padding: 16px; border-bottom: 1px solid #d0d7de; background: #f6f8fa; }
  .job-list { overflow-y: auto; flex: 1; }
  .job-item { padding: 16px; border-bottom: 1px solid #eaeef2; cursor: pointer; transition: background 0.2s; }
  .job-item:hover { background: #f6f8fa; }
  .job-item.active { background: #e6f7ff; border-left: 3px solid #0969da; }
  .job-title { font-weight: 600; font-size: 15px; color: #0969da; margin-bottom: 4px; }
  .job-company { font-size: 13px; color: #57606a; display: flex; justify-content: space-between; }
  .job-match-score { font-size: 12px; font-weight: bold; color: #1a7f37; background: #dafbe1; padding: 2px 6px; border-radius: 10px; }
  
  /* Main Content - Analysis */
  .main { flex: 1; display: flex; flex-direction: column; background: #fff; }
  .main-header { padding: 16px 24px; border-bottom: 1px solid #d0d7de; background: #fff; display: flex; justify-content: space-between; align-items: center; }
  .workspace { flex: 1; display: flex; overflow: hidden; }
  
  .panel { flex: 1; padding: 24px; overflow-y: auto; border-right: 1px solid #eaeef2; }
  .panel:last-child { border-right: none; }
  
  .analysis-card { background: #fff; border: 1px solid #d0d7de; border-radius: 8px; padding: 16px; margin-bottom: 16px; }
  .analysis-title { font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; font-size: 15px; }
  
  .keyword-tag { display: inline-block; padding: 4px 8px; font-size: 12px; border-radius: 4px; margin: 0 4px 4px 0; border: 1px solid transparent; }
  .keyword-missing { background: #ffebe9; color: #cf222e; border-color: #ff818266; }
  .keyword-match { background: #dafbe1; color: #1a7f37; border-color: #4ac26b66; }
  
  .tabs { display: flex; gap: 2px; border-bottom: 1px solid #d0d7de; margin-bottom: 16px; }
  .tab { padding: 8px 16px; cursor: pointer; border: 1px solid transparent; border-bottom: none; border-radius: 6px 6px 0 0; font-size: 14px; color: #57606a; }
  .tab.active { background: #fff; border-color: #d0d7de; border-bottom-color: #fff; font-weight: 600; color: #24292f; margin-bottom: -1px; }
  
  .resume-preview { font-family: "Times New Roman", serif; padding: 40px; background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.1); max-width: 800px; margin: 0 auto; min-height: 800px; font-size: 11pt; line-height: 1.35; color: #000; }
  .resume-preview h1 { font-size: 22pt; margin: 0 0 8px; text-align: center; text-transform: uppercase; letter-spacing: 1px; }
  .resume-preview .contact-info { text-align: center; margin-bottom: 16px; font-size: 10pt; }
  .resume-preview h3 { text-transform: uppercase; font-size: 11pt; margin: 16px 0 6px; border-bottom: 1px solid #000; padding-bottom: 2px; letter-spacing: 0.5px; font-weight: bold; }
  .resume-preview ul { margin: 2px 0 0 32px; padding: 0; }
  .resume-preview li { margin: 2px 0; font-size: 11pt; }
  .resume-preview .resume-row { display: flex; justify-content: space-between; align-items: baseline; }
  .resume-preview .resume-bold { font-weight: bold; }
  .resume-preview .resume-italic { font-style: italic; }
  .resume-preview .resume-sub { margin-bottom: 2px; font-size: 11pt; }
  .resume-item { margin-bottom: 4px; }
  
  .highlight-new { background-color: #fff8c5; }
  
  /* Loading Overlay */
  .overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.9); z-index: 200; display: none; align-items: center; justify-content: center; flex-direction: column; }
  .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #0969da; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 16px; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  
  .empty-state { text-align: center; padding: 40px; color: #57606a; }
  
  @media print {
     @page { margin: 0.45in 0.5in; size: auto; }
     
     /* Ensure body settings for print */
     body { 
        background-color: #fff; 
        -webkit-print-color-adjust: exact; 
        print-color-adjust: exact; 
        overflow: visible !important; 
        height: auto !important; 
     }
     
     /* Hide all top-level elements by default */
     body > * { display: none !important; }
     
     /* Only show the specific print container */
     #print-root { 
       display: block !important; 
       position: absolute !important;
       top: 0 !important;
       left: 0 !important;
       width: 100% !important;
       margin: 0 !important;
       padding: 0 !important;
       background: white;
     }

     /* Reset preview styles for print - MATCHING RESUME_FORM.HTML EXACTLY */
     .resume-preview { 
       width: 100% !important; 
       max-width: 100% !important; 
       margin: 0 !important; 
       padding: 0 !important; 
       box-shadow: none !important; 
       border: none !important;
       font-family: "Times New Roman", Times, serif !important;
       font-size: 10.8pt !important;
       line-height: 1.2 !important;
       color: #000 !important;
     }
 
     .resume-preview h1 { font-size: 20pt !important; margin-bottom: 6px !important; }
     .resume-preview h3 { font-size: 11pt !important; margin: 12px 0 6px !important; }
     .resume-preview .contact-info { margin-bottom: 14px !important; font-size: 10pt !important; }
     .resume-preview ul { margin-top: 1px !important; margin-bottom: 0 !important; }
     .resume-preview li { margin: 0.5px 0 !important; font-size: 10pt !important; }
     .resume-preview .resume-sub { margin-bottom: 1px !important; font-size: 10.8pt !important; }
     .resume-item { page-break-inside: avoid; margin-bottom: 0; }
     .resume-row { margin-bottom: 0 !important; }
     
     /* Prevent page breaks inside items */
     .item, li, p { page-break-inside: avoid; }
     h1, h2, h3 { page-break-after: avoid; }
   }
</style>
</head>
<body>

<div class="header">
  <div class="logo">
    <span>ü§ñ</span> AI Job Match & Tailor
  </div>
  <div style="display:flex; gap:12px; align-items:center">
    <select id="resumeSelector" class="btn" style="min-width: 200px;" onchange="loadSelectedResume()">
      <option value="">Select Resume Version...</option>
    </select>
    <a href="index.html" class="btn">üè† Home</a>
  </div>
</div>

<div class="container">
  <!-- Sidebar: Job Feed -->
  <div class="sidebar">
    <div class="sidebar-header">
      <div style="font-weight:600; margin-bottom:8px">Daily Top 10 Matches</div>
      <div style="font-size:12px; color:#57606a">Based on your profile ‚Ä¢ <span id="todayDate"></span></div>
    </div>
    <div id="jobList" class="job-list">
      <!-- Jobs will be injected here -->
    </div>
  </div>
  
  <!-- Main Content - Analysis -->
  <div class="main">
    <div class="main-header">
      <div style="flex:1">
        <div id="activeJobTitle" style="font-weight:bold; font-size:18px">Select a job to analyze</div>
        <a id="jobLink" href="#" target="_blank" style="font-size:13px; display:none; color:#0969da; text-decoration:none; margin-top:4px; align-items:center; gap:4px">
          üîó View Original Job Posting
        </a>
      </div>
      <button class="btn primary" onclick="runTailoring()" id="tailorBtn" disabled>‚ú® Auto-Tailor Resume</button>
    </div>
    
    <div class="workspace" id="workspace" style="display:none">
      <!-- Left Panel: Analysis -->
      <div class="panel" style="flex: 0.8; background: #f6f8fa;">
        <div class="analysis-card">
          <div class="analysis-title">üìä Match Score</div>
          <div style="display:flex; align-items:center; gap:16px; margin-bottom:12px">
            <div style="font-size:32px; font-weight:bold; color:#0969da" id="scoreValue">0%</div>
            <div style="flex:1; height:8px; background:#d0d7de; border-radius:4px; overflow:hidden">
              <div id="scoreBar" style="width:0%; height:100%; background:#0969da; transition: width 1s ease"></div>
            </div>
          </div>
        </div>
        
        <div class="analysis-card">
          <div class="analysis-title">üîë Keywords Analysis</div>
          <div style="font-size:13px; color:#57606a; margin-bottom:8px">Missing High-Value Keywords:</div>
          <div id="missingKeywords"></div>
          <div style="font-size:13px; color:#57606a; margin:12px 0 8px">Matched Keywords:</div>
          <div id="matchedKeywords"></div>
        </div>

        <div class="analysis-card">
           <div class="analysis-title">üìù Job Description</div>
           <div id="jobDesc" style="font-size:13px; white-space: pre-wrap; color: #24292f; max-height: 300px; overflow-y:auto"></div>
        </div>
      </div>
      
      <!-- Right Panel: Output -->
      <div class="panel" style="flex: 1.2; padding: 0;">
        <div style="padding: 16px; border-bottom: 1px solid #d0d7de; background: #fff; display: flex; justify-content: space-between; align-items: flex-end;">
          <div class="tabs" style="margin-bottom: 0; border-bottom: none;">
            <div class="tab active" onclick="switchTab('resume')" id="tabResume">üìÑ Tailored Resume</div>
            <div class="tab" onclick="switchTab('coverletter')" id="tabCover">‚úâÔ∏è Cover Letter</div>
            <div class="tab" onclick="switchTab('networking')" id="tabNetworking">ü§ù Networking Note</div>
          </div>
          <div id="actionButtons" style="display:flex; gap:8px;">
            <!-- Buttons injected by switchTab -->
          </div>
        </div>
        
        <div id="viewResume" style="padding: 24px; background: #eef2f5; height: calc(100% - 60px); overflow-y: auto;">
          <div id="tailoredResumePreview" class="resume-preview"></div>
        </div>
        
        <div id="viewCover" style="padding: 24px; background: #eef2f5; height: calc(100% - 60px); overflow-y: auto; display:none">
          <div id="coverLetterPreview" class="resume-preview" style="white-space: pre-wrap;"></div>
        </div>

        <div id="viewNetworking" style="padding: 24px; background: #eef2f5; height: calc(100% - 60px); overflow-y: auto; display:none">
          <div id="networkingPreview" class="resume-preview" style="white-space: pre-wrap;">
             <div style="color:#57606a;text-align:center;margin-top:40px">Click "Auto-Tailor Resume" to generate networking messages.</div>
          </div>
        </div>
      </div>
    </div>
    
    <div id="emptyState" class="empty-state">
      <h3>üëà Select a job from the list to start</h3>
      <p>AI will analyze the job description and optimize your resume keywords.</p>
    </div>
  </div>
</div>

<div class="overlay" id="loadingOverlay">
  <div class="spinner"></div>
  <h3 id="loadingText">Analyzing...</h3>
  <div style="color:#57606a; font-size:14px; margin-top:8px" id="loadingSub">Extracting keywords</div>
</div>

<div id="print-root"></div>

<script>
// --- Data & State ---
let currentResume = null;
let currentJob = null;
let tailoredResumeData = null;
let tailoredCoverLetterText = "";
let networkingNoteText = "";

// --- Job Database (Expanded for diverse roles) ---
const JOB_CATEGORIES = {
  "marketing": [
    { title: "Marketing Coordinator", company: "Coca-Cola", location: "Atlanta, GA", keywords: ["Social Media", "SEO", "Content Creation", "Market Research", "Campaign Management"], desc: "Support marketing campaigns and social media strategy.", sponsor: false },
    { title: "Social Media Manager", company: "TikTok", location: "Los Angeles, CA", keywords: ["Analytics", "Community Management", "Copywriting", "Brand Strategy", "Creative"], desc: "Manage brand presence and engage with community.", sponsor: true },
    { title: "Digital Marketing Specialist", company: "HubSpot", location: "Cambridge, MA", keywords: ["SEM", "PPC", "Google Analytics", "Email Marketing", "CRM"], desc: "Optimize digital channels and drive lead generation.", sponsor: true },
    { title: "Communications Specialist", company: "Edelman", location: "New York, NY", keywords: ["Public Relations", "Press Releases", "Media Relations", "Corporate Communications", "Writing"], desc: "Draft press materials and manage media inquiries.", sponsor: false },
    { title: "Brand Ambassador", company: "Red Bull", location: "Chicago, IL", keywords: ["Event Marketing", "Customer Service", "Sales", "Networking", "Promotions"], desc: "Represent the brand at events and drive awareness.", sponsor: false },
    { title: "Content Strategist", company: "Netflix", location: "Los Gatos, CA", keywords: ["Content Strategy", "Storytelling", "Editorial", "Social Media", "Video Production"], desc: "Develop content strategies for original series.", sponsor: true },
    { title: "Product Marketing Manager", company: "Salesforce", location: "San Francisco, CA", keywords: ["GTM Strategy", "Product Launch", "Sales Enablement", "Messaging", "B2B"], desc: "Lead go-to-market strategies for new products.", sponsor: true },
    { title: "PR Coordinator", company: "Disney", location: "Burbank, CA", keywords: ["Public Relations", "Media Lists", "Events", "Press Kits", "Communication"], desc: "Assist with PR campaigns and media events.", sponsor: false }
  ],
  "business": [
    { title: "Business Analyst", company: "McKinsey & Company", location: "New York, NY", keywords: ["Data Analysis", "Excel", "PowerPoint", "Strategy", "Consulting"], desc: "Analyze business processes and recommend improvements.", sponsor: true },
    { title: "Financial Analyst", company: "Goldman Sachs", location: "New York, NY", keywords: ["Financial Modeling", "Valuation", "Accounting", "Excel", "Finance"], desc: "Conduct financial analysis and market research.", sponsor: true },
    { title: "Operations Intern", company: "Amazon", location: "Seattle, WA", keywords: ["Operations", "Logistics", "Supply Chain", "Process Improvement", "Data Analysis"], desc: "Support fulfillment center operations and efficiency.", sponsor: true },
    { title: "HR Assistant", company: "Google", location: "Mountain View, CA", keywords: ["Human Resources", "Recruiting", "Employee Relations", "Communication", "Admin"], desc: "Assist with recruitment and employee onboarding.", sponsor: true },
    { title: "Sales Representative", company: "Salesforce", location: "San Francisco, CA", keywords: ["Sales", "CRM", "Negotiation", "Lead Generation", "Communication"], desc: "Drive sales revenue and manage client relationships.", sponsor: true },
    { title: "Management Trainee", company: "Enterprise", location: "St. Louis, MO", keywords: ["Management", "Sales", "Customer Service", "Leadership", "Operations"], desc: "Learn all aspects of business management and operations.", sponsor: false }
  ],
  "design": [
    { title: "UI/UX Designer", company: "Airbnb", location: "San Francisco, CA", keywords: ["Figma", "Sketch", "Prototyping", "User Research", "Wireframing"], desc: "Design intuitive user interfaces and experiences.", sponsor: true },
    { title: "Graphic Designer", company: "Nike", location: "Beaverton, OR", keywords: ["Adobe Creative Suite", "Photoshop", "Illustrator", "Branding", "Typography"], desc: "Create visual assets for marketing campaigns.", sponsor: true },
    { title: "Junior Designer", company: "Local Agency", location: "Austin, TX", keywords: ["Canva", "Social Media", "Layout", "Print Design"], desc: "Assist with daily design tasks for local clients.", sponsor: false },
    { title: "Product Designer", company: "Spotify", location: "New York, NY", keywords: ["Product Design", "UX", "Visual Design", "Interaction Design", "Prototyping"], desc: "Design new features for the Spotify app.", sponsor: true },
    { title: "Visual Designer", company: "Apple", location: "Cupertino, CA", keywords: ["Visual Design", "Iconography", "Sketch", "Photoshop", "Detail Oriented"], desc: "Create stunning visuals for Apple products.", sponsor: true }
  ],
  "engineering": [
    { title: "Software Engineer Intern", company: "Google", location: "Mountain View, CA", keywords: ["Python", "Java", "C++", "Data Structures", "Algorithms", "Mobile App"], desc: "Design and implement software solutions.", sponsor: true },
    { title: "Data Analyst", company: "Meta", location: "Menlo Park, CA", keywords: ["SQL", "Python", "Tableau", "PowerBI", "Data Visualization"], desc: "Analyze data to drive product decisions.", sponsor: true },
    { title: "Web Developer", company: "Small Biz Solutions", location: "Remote", keywords: ["HTML", "CSS", "JavaScript", "WordPress", "PHP"], desc: "Maintain websites for small business clients.", sponsor: false },
    { title: "Frontend Engineer", company: "Airbnb", location: "Remote", keywords: ["JavaScript", "TypeScript", "React", "HTML", "CSS"], desc: "Build modern web applications.", sponsor: true },
    { title: "Machine Learning Engineer", company: "OpenAI", location: "San Francisco, CA", keywords: ["Deep Learning", "PyTorch", "Python", "LLM", "AI"], desc: "Train and deploy large language models.", sponsor: true },
    { title: "IT Support Specialist", company: "University Health", location: "Chicago, IL", keywords: ["Help Desk", "Troubleshooting", "Windows", "Networking"], desc: "Provide technical support to staff.", sponsor: false }
  ],
  "science": [
    { title: "Bioinformatics Associate", company: "Genentech", location: "South San Francisco, CA", keywords: ["Python", "R", "NGS", "Genomics", "Biology"], desc: "Analyze genomic data for drug discovery.", sponsor: true },
    { title: "Research Associate", company: "Pfizer", location: "Cambridge, MA", keywords: ["Lab Techniques", "PCR", "Cell Culture", "Data Analysis", "Biology"], desc: "Conduct experiments to support vaccine development.", sponsor: true },
    { title: "Lab Assistant", company: "University of Illinois", location: "Urbana, IL", keywords: ["Lab Safety", "Equipment Maintenance", "Data Entry", "Chemistry", "Biology"], desc: "Assist researchers with daily lab operations.", sponsor: false },
    { title: "Science Tutor", company: "Varsity Tutors", location: "Remote", keywords: ["Teaching", "Biology", "Chemistry", "Communication"], desc: "Tutor high school students in science subjects.", sponsor: false }
  ],
  "agtech": [
    { title: "Precision Ag Intern", company: "John Deere", location: "Champaign, IL", keywords: ["Python", "GIS", "Data Analysis", "IoT", "Sensors"], desc: "Develop software for autonomous tractors and precision agriculture.", sponsor: true },
    { title: "R&D Intern", company: "Bayer Crop Science", location: "St. Louis, MO", keywords: ["Genetics", "R", "Statistics", "Field Research", "Biology"], desc: "Support breeding pipelines and genomic research.", sponsor: true },
    { title: "Field Scout", company: "Crop Watchers", location: "Decatur, IL", keywords: ["Scouting", "Pest Management", "Data Collection", "Driving"], desc: "Monitor fields for pests and diseases.", sponsor: false },
    { title: "Digital Ag Intern", company: "Corteva", location: "Johnston, IA", keywords: ["Remote Sensing", "Machine Learning", "Python", "Satellite Imagery"], desc: "Analyze satellite data to optimize crop yields.", sponsor: true },
    { title: "Ag Engineering Intern", company: "ADM", location: "Decatur, IL", keywords: ["Process Engineering", "AutoCAD", "Manufacturing", "Supply Chain"], desc: "Optimize food processing facilities.", sponsor: true }
  ]
};

const KEYWORD_MAPPING = {
  "marketing": ["marketing", "social media", "communication", "communications", "brand", "content", "seo", "sem", "advertising", "pr", "media", "campaign", "copywriting", "market research", "digital", "public relations", "strategic", "market", "promotion"],
  "business": ["business", "management", "finance", "consulting", "sales", "strategy", "operations", "economics", "accounting", "admin", "hr", "analyst", "project management", "entrepreneurship", "commerce"],
  "design": ["design", "ui", "ux", "graphic", "adobe", "figma", "sketch", "creative", "art", "visual", "multimedia", "animation", "illustration"],
  "engineering": ["software", "developer", "engineer", "coding", "programming", "java", "python", "c++", "react", "computer", "tech", "data", "aws", "cloud", "full stack", "backend", "frontend", "cs"],
  "science": ["biology", "chemistry", "lab", "research", "science", "genetics", "bioinformatics", "pharmaceutical", "medical", "clinical", "physics", "neuroscience", "biotech"],
  "agtech": ["ag", "agriculture", "agricultural", "crop", "farm", "soil", "food science", "nutrition", "sustainability", "environmental", "jhon deere", "bayer", "corteva"]
};

let MOCK_JOBS = []; // Will be populated dynamically

// --- Initialization ---
document.getElementById('todayDate').innerText = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
// loadResumeVersions will be called at the end of the script

// --- Functions ---
// (Redundant functions removed)

function analyzeResumeAndRenderJobs() {
  if (!currentResume) return;

  // 1. Extract text from resume
  const resumeText = JSON.stringify(currentResume).toLowerCase();
  
  // 2. Score categories
  const scores = {};
  
  // Base keyword scoring
  for (const [category, keywords] of Object.entries(KEYWORD_MAPPING)) {
    let count = 0;
    keywords.forEach(k => {
      // Simple occurrence check
      if (resumeText.includes(k)) count++;
      // Boost if it's in the "Education" section specifically (heuristic)
      if (currentResume.edu && JSON.stringify(currentResume.edu).toLowerCase().includes(k)) {
          count += 3; // Weight education matches EVEN HIGHER
      }
    });
    scores[category] = count;
  }
  
  // 3. Determine top category
  let topCategory = "engineering"; // Default
  let maxScore = -1;
  
  console.log("Category Scores:", scores); // Debugging

  for (const [category, score] of Object.entries(scores)) {
    if (score > maxScore) {
      maxScore = score;
      topCategory = category;
    }
  }
  
  // Fallback / Override: Check major/degree explicitly
  // If the resume has education, we trust the major more than random keywords
  if (currentResume.edu && currentResume.edu.length > 0) {
      const edu = currentResume.edu[0];
      const degree = (edu.degree || "").toLowerCase();
      const major = (edu.major || "").toLowerCase();
      const combined = degree + " " + major;
      
      // Override if specific keywords are found in major/degree
      if (combined.includes('art') || combined.includes('design')) topCategory = 'design';
      else if (combined.includes('business') || combined.includes('finance') || combined.includes('econ') || combined.includes('mba') || combined.includes('commerce')) topCategory = 'business';
      else if (combined.includes('market') || combined.includes('comm') || combined.includes('public relation') || combined.includes('media') || combined.includes('advertising')) topCategory = 'marketing';
      else if (combined.includes('ag') || combined.includes('crop') || combined.includes('food') || combined.includes('env')) topCategory = 'agtech';
      else if (combined.includes('bio') || combined.includes('chem') || combined.includes('sci') || combined.includes('physics')) topCategory = 'science';
      else if (combined.includes('eng') || combined.includes('cs') || combined.includes('comp') || combined.includes('tech')) topCategory = 'engineering';
  }

  // 4. Generate Job List
  // Start with all jobs from the top category
  let jobs = [...(JOB_CATEGORIES[topCategory] || [])];
  
  // Add limited "Wildcard" jobs (max 2)
  const otherCategories = Object.keys(JOB_CATEGORIES).filter(c => c !== topCategory);
  // Shuffle other categories to get random variety
  otherCategories.sort(() => 0.5 - Math.random());
  
  // Take 1 job from first 2 random other categories
  otherCategories.slice(0, 2).forEach(c => {
    if (JOB_CATEGORIES[c] && JOB_CATEGORIES[c].length > 0) {
        jobs.push(JOB_CATEGORIES[c][0]); 
    }
  });

  // Ensure we have non-sponsoring jobs for the filter demo
  const nonSponsoring = [];
  Object.values(JOB_CATEGORIES).flat().forEach(j => {
      if (j.sponsor === false) nonSponsoring.push(j);
  });
  // Shuffle non-sponsoring and take 2 unique ones that aren't already in jobs
  const currentIds = new Set(jobs.map(j => j.title + j.company));
  const extras = nonSponsoring.filter(j => !currentIds.has(j.title + j.company))
                              .sort(() => 0.5 - Math.random())
                              .slice(0, 2);
  jobs.push(...extras);

  // Shuffle final list
  jobs = jobs.sort(() => 0.5 - Math.random());
  
  // Limit to 10
  MOCK_JOBS = jobs.slice(0, 10).map((job, index) => ({
      ...job,
      id: index + 1
  }));
  
  // Update Header Text to show personalization
  const catTitle = topCategory.charAt(0).toUpperCase() + topCategory.slice(1);
  const dateStr = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
  
  document.querySelector('.sidebar-header').innerHTML = `
      <div style="font-weight:600; margin-bottom:8px">Daily Top 10 Matches <span style="font-size:12px;color:#0969da;background:#ddf4ff;padding:2px 6px;border-radius:10px;margin-left:4px">${catTitle} Focus</span></div>
      <div style="font-size:12px; color:#57606a; display:flex; justify-content:space-between; align-items:center;">
          <span>Based on your profile ‚Ä¢ ${dateStr}</span>
          <label style="cursor:pointer; display:flex; align-items:center; gap:4px; font-weight:700; color:#cf222e; background:#ffebe9; padding:2px 8px; border-radius:6px; border:1px solid #cf222e">
             <input type="checkbox" id="visaToggle" onchange="renderJobs()" style="accent-color:#cf222e"> üõÇ Visa Only
          </label>
      </div>
  `;

  renderJobs();
  
  // Show Toast
  showToast(`Jobs refreshed for ${currentResume.name || 'Resume'}!`);
}

function showToast(msg) {
    let toast = document.getElementById('toast');
    if (!toast) {
        toast = document.createElement('div');
        toast.id = 'toast';
        toast.style.cssText = 'position:fixed;bottom:20px;right:20px;background:#333;color:#fff;padding:12px 24px;border-radius:4px;z-index:1000;display:none;transition:opacity 0.3s;font-size:14px;box-shadow:0 2px 5px rgba(0,0,0,0.2);';
        document.body.appendChild(toast);
    }
    toast.innerText = msg;
    toast.style.display = 'block';
    // Trigger reflow
    void toast.offsetWidth;
    toast.style.opacity = '1';
    
    // Clear previous timeout if any
    if (toast.timeoutId) clearTimeout(toast.timeoutId);
    
    toast.timeoutId = setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.style.display = 'none', 300);
    }, 3000);
}

function renderJobs() {
  const list = document.getElementById('jobList');
  const visaOnly = document.getElementById('visaToggle')?.checked;
  list.innerHTML = '';
  MOCK_JOBS.forEach(job => {
    if (visaOnly && !job.sponsor) return;
    
    const div = document.createElement('div');
    div.className = 'job-item';
    div.onclick = () => selectJob(job, div);
    
    let sponsorBadge = '';
    if (job.sponsor) {
        sponsorBadge = '<span style="font-size:10px;background:#dafbe1;color:#1a7f37;padding:1px 4px;border-radius:4px;margin-left:6px;border:1px solid rgba(26,127,55,0.2)">üá∫üá∏ Visa Friendly</span>';
    }

    div.innerHTML = `
      <div class="job-title">${job.title}${sponsorBadge}</div>
      <div class="job-company">
        <span>${job.company}</span>
        <span>${job.location}</span>
      </div>
    `;
    list.appendChild(div);
  });
}

function selectJob(job, el) {
  currentJob = job;
  // UI Update
  document.querySelectorAll('.job-item').forEach(e => e.classList.remove('active'));
  el.classList.add('active');
  
  document.getElementById('emptyState').style.display = 'none';
  document.getElementById('workspace').style.display = 'flex';
  
  let sponsorBadge = '';
  if (job.sponsor) {
      sponsorBadge = '<span style="font-size:12px;background:#dafbe1;color:#1a7f37;padding:2px 6px;border-radius:10px;margin-left:8px;vertical-align:middle;border:1px solid rgba(26,127,55,0.2)">üá∫üá∏ Visa Sponsorship Available</span>';
  }
  
  document.getElementById('activeJobTitle').innerHTML = `${job.title} @ ${job.company} ${sponsorBadge}`;
  
  // Set Job Link
  const jobLink = document.getElementById('jobLink');
  jobLink.style.display = 'inline-flex';
  // Use Google Jobs Search for best coverage
  jobLink.href = `https://www.google.com/search?q=${encodeURIComponent(job.title + " " + job.company + " careers")}&ibp=htl;jobs`;
  
  document.getElementById('tailorBtn').disabled = false;
  document.getElementById('jobDesc').innerText = job.desc;
  
  // Reset Output
  document.getElementById('viewResume').style.display = 'block';
  document.getElementById('viewCover').style.display = 'none';
  document.getElementById('tabResume').classList.add('active');
  document.getElementById('tabCover').classList.remove('active');
  document.getElementById('tailoredResumePreview').innerHTML = '<div style="color:#57606a;text-align:center;margin-top:40px">Click "Auto-Tailor Resume" to generate optimized version.</div>';
  
  tailoredResumeData = null; // Reset
  analyzeMatch();
  updateActionButtons();
}

function analyzeMatch() {
  if (!currentResume || !currentJob) return;
  
  // Simple Keyword Matching Logic
  const resumeText = JSON.stringify(currentResume).toLowerCase();
  const jobKeywords = currentJob.keywords;
  
  const matched = [];
  const missing = [];
  
  jobKeywords.forEach(k => {
    if (resumeText.includes(k.toLowerCase())) {
      matched.push(k);
    } else {
      missing.push(k);
    }
  });
  
  // Calculate Score
  const score = Math.round((matched.length / jobKeywords.length) * 100);
  
  // Update UI
  document.getElementById('scoreValue').innerText = score + '%';
  document.getElementById('scoreBar').style.width = score + '%';
  document.getElementById('scoreBar').style.background = score > 70 ? '#1a7f37' : (score > 40 ? '#d29922' : '#cf222e');
  
  const renderTags = (arr, type, containerId) => {
    const c = document.getElementById(containerId);
    c.innerHTML = '';
    if (arr.length === 0) {
      c.innerHTML = '<span style="font-size:12px;color:#57606a">None</span>';
      return;
    }
    arr.forEach(k => {
      const span = document.createElement('span');
      span.className = `keyword-tag keyword-${type}`;
      span.innerText = k;
      c.appendChild(span);
    });
  };
  
  renderTags(missing, 'missing', 'missingKeywords');
  renderTags(matched, 'match', 'matchedKeywords');
}

async function runTailoring() {
  if (!currentResume) { alert("Please select a resume version first."); return; }
  if (!currentJob) { alert("Please select a job first."); return; }

  const overlay = document.getElementById('loadingOverlay');
  const txt = document.getElementById('loadingText');
  const sub = document.getElementById('loadingSub');
  
  overlay.style.display = 'flex';
  
  // Simulation Steps
  txt.innerText = 'Analyzing Job Requirements...';
  await new Promise(r => setTimeout(r, 1000));
  
  txt.innerText = 'Optimizing Resume Structure...';
  sub.innerText = 'Injecting missing keywords: ' + document.getElementById('missingKeywords').innerText;
  await new Promise(r => setTimeout(r, 1200));
  
  txt.innerText = 'Drafting Cover Letter & Networking Note...';
  sub.innerText = 'Personalizing for ' + currentJob.company;
  await new Promise(r => setTimeout(r, 1000));
  
  overlay.style.display = 'none';
  
  generateTailoredResume();
  generateCoverLetter();
  generateNetworkingNote();
}

function generateTailoredResume() {
  try {
    if (!currentResume) {
        alert("Error: No resume selected. Please select a resume from the dropdown.");
        return;
    }
    if (!currentJob) {
        alert("Error: No job selected. Please select a job from the list.");
        return;
    }

    console.log("Generating tailored resume for:", currentJob.company);

    // Deep copy resume
    const d = JSON.parse(JSON.stringify(currentResume));
    
    // Ensure arrays exist to prevent crashes
    d.edu = d.edu || [];
    d.exps = d.exps || [];
    d.projects = d.projects || [];
    d.activities = d.activities || [];
    d.skills = d.skills || [];

    const missing = [];
    if (currentJob.keywords) {
      currentJob.keywords.forEach(k => {
         if (!JSON.stringify(d).toLowerCase().includes(k.toLowerCase())) missing.push(k);
      });
    }
    
    // Inject keywords into Skills (Mock Tailoring)
    if (missing.length > 0) {
       // Create a visible string for the skills
       const newSkillName = `Targeted Skills for ${currentJob.company}: ${missing.join(', ')}`;
       d.skills.unshift({ name: newSkillName, level: "Targeted" });
    }
    
    tailoredResumeData = d;
    
    // Render Resume - STRICTLY following resume_form.html structure
    const root = document.getElementById('tailoredResumePreview');
    if (!root) return;
    root.innerHTML = '';
    
    // Helper for Elements
    const el = (tag, cls) => {
        const e = document.createElement(tag);
        if(cls) e.className = cls;
        return e;
    };

    // 1. Header
    const h1 = el('h1'); 
    h1.innerText = d.name || 'YOUR NAME'; 
    root.appendChild(h1);
    
    const info = el('div', 'contact-info'); 
    const contactParts = [];
    if (d.phone) contactParts.push(d.phone);
    if (d.email) contactParts.push(d.email);
    if (d.linkedin) contactParts.push(d.linkedin);
    if (d.github) contactParts.push(d.github);
    if (d.website) contactParts.push(d.website);
    
    info.innerText = contactParts.join(' | '); 
    root.appendChild(info);
    
    // Helper for Sections
    const addSec = (t) => { 
        const h = el('h3'); 
        h.innerText = t; 
        root.appendChild(h); 
    };
    
    // Helper for Rows (Left/Right align) matching resume_form.html
    const addRow = (container, l, r, bold = false, italic = false) => { 
       const row = el('div', 'resume-row');
       if(bold) row.classList.add('resume-bold');
       if(italic) row.classList.add('resume-italic');
       
       const left = el('span'); left.innerText = l; row.appendChild(left);
       const right = el('span'); right.innerText = r; row.appendChild(right);
       container.appendChild(row);
    };
    
    // 2. EDUCATION
    if(d.edu && d.edu.length) { 
        addSec('EDUCATION'); 
        d.edu.forEach(e => {
            const item = el('div', 'resume-item');
            // Line 1: School - Location (Bold)
            addRow(item, e.school || '', e.city || '', true, false);
            // Line 2: Degree/Major - Period (Italic)
            const degreeInfo = [e.degree, e.major].filter(Boolean).join(', ');
            addRow(item, degreeInfo, e.period || '', false, true);
            // GPA
            if(e.gpa) {
               const gpaDiv = el('div', 'resume-sub');
               gpaDiv.innerText = `GPA: ${e.gpa}`;
               item.appendChild(gpaDiv);
            }
            root.appendChild(item);
        });
        // Relevant Courses (Global field in data)
        if (d.courses) {
            const coursesDiv = el('div', 'resume-sub');
            coursesDiv.style.marginTop = '2px';
            coursesDiv.innerHTML = `<strong>Relevant Courses:</strong> ${d.courses}`;
            root.appendChild(coursesDiv);
        }
    }
    
    // 3. PROFESSIONAL EXPERIENCE
    if(d.exps && d.exps.length) { 
      addSec('PROFESSIONAL EXPERIENCE'); 
      d.exps.forEach((e, i) => {
          const item = el('div', 'resume-item');
          // Line 1: Company - Location (Bold)
          addRow(item, e.company || '', e.location || '', true, false);
          // Line 2: Title - Period (Italic)
          addRow(item, e.title || '', e.period || '', false, true);
          
          if (e.desc) {
              const ul = el('ul');
              let descText = e.desc;
              
              // Tailoring: Add a sentence to the first experience if it's relevant
              if (i === 0 && missing.length > 0) {
                   descText = `Applied ${missing[0]} techniques to optimize workflows, aligning with ${currentJob.company} standards.\n` + descText;
              }

              descText.split('\n').forEach(li => { 
                  if(li.trim()) {
                      const liEl = el('li');
                      // Highlight the new tailored line
                      if (li.includes(missing[0]) && li.includes(currentJob.company)) {
                          liEl.className = 'highlight-new';
                      }
                      liEl.innerText = li.replace(/^- /, '');
                      ul.appendChild(liEl);
                  }
              });
              item.appendChild(ul);
          }
          root.appendChild(item);
      });
    }
    
    // 4. PROJECTS & OUTSIDE EXPERIENCE
    if(d.projects && d.projects.length) {
      addSec('PROJECTS & OUTSIDE EXPERIENCE');
      d.projects.forEach((p, i) => {
          const item = el('div', 'resume-item');
          // Line 1: Name - Location (Bold)
          addRow(item, p.name || '', p.location || '', true, false);
          // Line 2: Title - Period (Italic)
          addRow(item, p.title || '', p.period || '', false, true);
          
          // Line 3: Stack | Link (Italic)
          let subStack = p.stack || '';
          if(p.link) subStack += (subStack ? ` | ${p.link}` : p.link);
          
          if(subStack) {
              const row = el('div', 'resume-row');
              const left = el('span'); 
              left.innerHTML = `<em>${subStack}</em>`; 
              row.appendChild(left);
              item.appendChild(row);
          }
          
          const ul = el('ul');
          let desc = p.desc || '';
          // Mock injection for first project
          if (i === 0 && missing.length > 0) {
              desc += `\n- Integrated ${missing.slice(0, 2).join(' and ')} to enhance project scalability.`;
          }
          
          desc.split('\n').forEach(li => { 
              if(li.trim()) {
                  const isNew = li.includes('Integrated') && li.includes('scalability');
                  const liEl = el('li');
                  if(isNew) liEl.className = 'highlight-new';
                  liEl.innerText = li.replace(/^- /, '');
                  ul.appendChild(liEl);
              }
          });
          item.appendChild(ul);
          root.appendChild(item);
      });
    }
    
    // 5. ACTIVITIES & LEADERSHIP
    if(d.activities && d.activities.length) {
        addSec('ACTIVITIES & LEADERSHIP');
        d.activities.forEach(a => {
            const item = el('div', 'resume-item');
            // Line 1: Org - Location (Bold)
            addRow(item, a.org || '', a.location || '', true, false);
            // Line 2: Role - Period (Italic)
            addRow(item, a.role || '', a.period || '', false, true);
            
            if (a.desc) {
                const ul = el('ul');
                a.desc.split('\n').forEach(li => {
                    if(li.trim()) {
                        const liEl = el('li');
                        liEl.innerText = li.replace(/^- /, '');
                        ul.appendChild(liEl);
                    }
                });
                item.appendChild(ul);
            }
            root.appendChild(item);
        });
    }
    
    // 6. SKILLS & INTERESTS
    if((d.skills && d.skills.length) || d.languages || d.interests) {
        addSec('SKILLS & INTERESTS');
        const div = el('div', 'resume-sub');
        
        // Skills
        if (d.skills && d.skills.length) {
            const row = el('div');
            // Map skills to text, highlighting the targeted ones
            const skillsHtml = d.skills.map(s => {
               const text = s.name; // resume_form.html only uses name
               const isNew = text.startsWith('Targeted Skills');
               return isNew ? `<span class="highlight-new">${text}</span>` : text;
            }).join(', ');
            
            row.innerHTML = `<strong>Skills:</strong> ${skillsHtml}`;
            div.appendChild(row);
        }
        
        // Interests
        if (d.interests) {
             const row = el('div');
             row.innerHTML = `<strong>Interests:</strong> ${d.interests}`;
             div.appendChild(row);
        }
        
        // Languages
        if (d.languages) {
             const row = el('div');
             row.innerHTML = `<strong>Languages:</strong> ${d.languages}`;
             div.appendChild(row);
        }
        
        root.appendChild(div);
    }
    
    updateActionButtons();
  } catch (err) {
      console.error("Resume Generation Error:", err);
      alert("An error occurred while generating the resume. Please check console for details.");
  }
}

function generateCoverLetter() {
  console.log("Starting Cover Letter Generation...");
  try {
    const d = currentResume;
    const j = currentJob;
    if (!d) { 
        console.error("Missing Resume Data"); 
        alert("Error: Resume data is missing. Please select a resume.");
        return; 
    }
    if (!j) { 
        console.error("Missing Job Data"); 
        alert("Error: Job data is missing. Please select a job.");
        return; 
    }

    const today = new Date().toLocaleDateString();
    
    // Safe accessors with defaults
    const school = (d.edu && Array.isArray(d.edu) && d.edu[0] && d.edu[0].school) ? d.edu[0].school : '[University Name]';
    const major = (d.edu && Array.isArray(d.edu) && d.edu[0] && d.edu[0].major) ? d.edu[0].major : '[Major]';
    const skill = (d.skills && Array.isArray(d.skills) && d.skills[0] && d.skills[0].name) ? d.skills[0].name : '[Top Skill]';
    const prevComp = (d.exps && Array.isArray(d.exps) && d.exps[0] && d.exps[0].company) ? d.exps[0].company : '[Previous Company]';
    
    // Job keywords safety
    const jobKeywords = (j.keywords && Array.isArray(j.keywords) && j.keywords.length) ? j.keywords : ['relevant skills'];
    const topSkill = jobKeywords[0];
    const top3Skills = jobKeywords.slice(0, 3).join(', ');

    const text = `
${d.name || 'Applicant Name'}
${d.email || ''} | ${d.phone || ''}

${today}

Hiring Manager
${j.company}
${j.location || ''}

Dear Hiring Manager,

I am writing to express my strong interest in the ${j.title} position at ${j.company}, as advertised. With my background in ${major} from ${school}, and my hands-on experience in ${skill}, I am confident in my ability to contribute effectively to your team.

I have long admired ${j.company}'s work in the industry, particularly its commitment to innovation. In my previous role at ${prevComp}, I honed my skills in ${top3Skills}, which aligns perfectly with the requirements for this role.

Specifically, I have experience using ${topSkill} to solve complex problems, a skill I am eager to apply at ${j.company}. I am a quick learner and thrive in collaborative environments.

Thank you for considering my application. I look forward to the possibility of discussing how my skills and experiences align with the needs of your team.

Sincerely,

${d.name || 'Applicant Name'}
    `;
    
    const el = document.getElementById('coverLetterPreview');
    if (el) {
        el.innerText = text.trim();
        console.log("Cover Letter Updated successfully");
    } else {
        console.error("Cover Letter Element Not Found (ID: coverLetterPreview)");
        alert("Error: Cover Letter preview element not found.");
    }
    tailoredCoverLetterText = text.trim();
    
    updateActionButtons();
  } catch (err) {
      console.error("Cover Letter Error:", err);
      alert("Error generating Cover Letter: " + err.message);
  }
}

function generateNetworkingNote() {
  console.log("Starting Networking Note Generation...");
  try {
    const d = currentResume;
    const j = currentJob;
    
    if (!d) {
        console.error("Networking Note: Missing Resume");
        alert("Error: Resume data missing for Networking Note.");
        return;
    }
    if (!j) {
        console.error("Networking Note: Missing Job");
        alert("Error: Job data missing for Networking Note.");
        return;
    }

    // Extract a key project or skill to make it specific
    const keySkill = (j.keywords && j.keywords[0]) ? j.keywords[0] : "relevant skills";
    const university = (d.edu && Array.isArray(d.edu) && d.edu[0] && d.edu[0].school) ? d.edu[0].school : "[University]";
    const major = (d.edu && Array.isArray(d.edu) && d.edu[0] && d.edu[0].major) ? d.edu[0].major : "[Major]";

    const text = `
SUBJECT: Student Inquiry: ${j.title} role - ${d.name || 'Student'}

Hi [Hiring Manager Name/Alumni],

I recently came across the ${j.title} position at ${j.company} and was immediately drawn to your team's work in [mention a specific product/mission].

As a ${major} student at ${university} with experience in ${keySkill}, I believe my background aligns well with the team's needs. I recently completed a project where I [mention a relevant achievement using ${keySkill}], which I think would be relevant to the work at ${j.company}.

I would appreciate the opportunity to briefly connect and learn more about your team's current challenges. Are you open to a 10-minute chat next week?

Best regards,

${d.name || 'Student'}
[Link to Portfolio/LinkedIn]
    `;

    const el = document.getElementById('networkingPreview');
    if (el) {
        el.innerText = text.trim();
        console.log("Networking Note Updated successfully");
    } else {
        console.error("Networking Note Element Not Found (ID: networkingPreview)");
        alert("Error: Networking Note preview element not found.");
    }
    networkingNoteText = text.trim();
    
    updateActionButtons();
  } catch (err) {
      console.error("Networking Note Error:", err);
      alert("Error generating Networking Note: " + err.message);
  }
}

function updateActionButtons() {
  const container = document.getElementById('actionButtons');
  container.innerHTML = '';
  
  if (!tailoredResumeData) return;
  
  const isResume = document.getElementById('tabResume').classList.contains('active');
  const isCover = document.getElementById('tabCover').classList.contains('active');
  
  if (isResume) {
     container.innerHTML = `
       <button class="btn" onclick="saveToHistory()">üíæ Save to History</button>
       <button class="btn primary" onclick="printContent('tailoredResumePreview')">üì• Download PDF</button>
     `;
   } else if (isCover) {
     container.innerHTML = `
       <button class="btn" onclick="copyText(tailoredCoverLetterText)">üìã Copy Text</button>
       <button class="btn primary" onclick="printContent('coverLetterPreview')">üì• Download PDF</button>
     `;
   } else {
     // Networking
     container.innerHTML = `
       <button class="btn primary" onclick="copyText(networkingNoteText)">üìã Copy Message</button>
     `;
   }
}

function saveToHistory() {
  if (!tailoredResumeData || !currentJob) return;
  
  const versions = JSON.parse(localStorage.getItem('resume_versions') || '[]');
  const newVersion = {
    name: `${tailoredResumeData.name} - ${currentJob.company} (Tailored)`,
    createdAt: new Date().toISOString(),
    data: tailoredResumeData
  };
  
  versions.push(newVersion);
  localStorage.setItem('resume_versions', JSON.stringify(versions));
  
  alert('Resume saved to Resume Builder History!');
  loadResumeVersions(); // Refresh dropdown
}

function printContent(elementId) {
  const content = document.getElementById(elementId);
  const printRoot = document.getElementById('print-root');
  
  if (!content || !printRoot) return;
  
  // Clone the content to print
  printRoot.innerHTML = '';
  const clone = content.cloneNode(true);
  clone.removeAttribute('id'); // Remove ID to avoid duplicates
  
  printRoot.appendChild(clone);
  
  window.print();
  
  // Clean up after print dialog closes
  const cleanup = () => {
      printRoot.innerHTML = '';
      window.removeEventListener('afterprint', cleanup);
  };
  window.addEventListener('afterprint', cleanup);
}

function copyText(text) {
  const txt = (typeof text === 'string') ? text : tailoredCoverLetterText;
  navigator.clipboard.writeText(txt).then(() => {
    alert('Content copied to clipboard!');
  });
}

function switchTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById('viewResume').style.display = 'none';
  document.getElementById('viewCover').style.display = 'none';
  document.getElementById('viewNetworking').style.display = 'none';

  if (tab === 'resume') {
    document.getElementById('tabResume').classList.add('active');
    document.getElementById('viewResume').style.display = 'block';
  } else if (tab === 'coverletter') {
    document.getElementById('tabCover').classList.add('active');
    document.getElementById('viewCover').style.display = 'block';
  } else {
    document.getElementById('tabNetworking').classList.add('active');
    document.getElementById('viewNetworking').style.display = 'block';
  }
  updateActionButtons();
}

// Initialize
const MOCK_RESUME_DATA = {
  name: "Michael Scott",
  email: "michael@dundermifflin.com",
  phone: "570-555-1234",
  edu: [{ school: "University of Scranton", degree: "B.A.", major: "Business", city: "Scranton, PA", period: "1984" }],
  exps: [{ company: "Dunder Mifflin", title: "Regional Manager", location: "Scranton, PA", period: "2005 - 2011", desc: "- Managed branch operations and sales team.\n- Organized diversity training and fun run events." }],
  skills: [{ name: "Sales", level: "Advanced" }, { name: "Management", level: "Expert" }]
};

function loadResumeVersions() {
  const selector = document.getElementById('resumeSelector');
  selector.innerHTML = '<option value="">Select Resume Version...</option>';
  
  let hasResume = false;
  try {
    const versions = JSON.parse(localStorage.getItem('resume_versions') || '[]');
    if (versions.length > 0) {
        hasResume = true;
        versions.forEach((v, index) => {
          const opt = document.createElement('option');
          opt.value = index; 
          opt.innerText = v.name || `Resume ${index + 1}`;
          selector.appendChild(opt);
        });
        
        // Don't auto-select first resume
        // selector.value = 0;
        // loadSelectedResume();
    }
  } catch (e) {
    console.error("Error loading resume versions:", e);
  }

  // Add Demo Option if no resume found (or always, for testing)
  if (!hasResume) {
      const opt = document.createElement('option');
      opt.value = "demo";
      opt.innerText = "üìÑ Demo Resume (Michael Scott)";
      selector.appendChild(opt);
      // Auto-select demo ONLY if no user resume exists
      selector.value = "demo";
      loadSelectedResume();
  } else {
      // Add Demo Option as an alternative
      const opt = document.createElement('option');
      opt.value = "demo";
      opt.innerText = "üìÑ Demo Resume (Michael Scott)";
      selector.appendChild(opt);
  }
}

function loadSelectedResume() {
  const selector = document.getElementById('resumeSelector');
  const index = selector.value;
  
  console.log("Loading resume index:", index);

  if (index === "") {
    currentResume = null;
    resetAnalysisUI();
    return;
  }
  
  if (index === "demo") {
      currentResume = MOCK_RESUME_DATA;
      console.log("Loaded Demo Resume");
      analyzeResumeAndRenderJobs(); // Refresh job list
      if (currentJob) analyzeMatch();
      return;
  }
  
  try {
    const versions = JSON.parse(localStorage.getItem('resume_versions') || '[]');
    if (versions[index]) {
      currentResume = versions[index].data;
      console.log("Loaded Resume:", currentResume.name);
      analyzeResumeAndRenderJobs(); // Refresh job list
      if (currentJob) {
          analyzeMatch();
      }
    }
  } catch (e) {
    console.error("Error loading selected resume:", e);
    alert("Error loading resume data. Please try saving your resume again.");
  }
}

function resetAnalysisUI() {
    document.getElementById('scoreValue').innerText = '0%';
    document.getElementById('scoreBar').style.width = '0%';
    document.getElementById('missingKeywords').innerHTML = '';
    document.getElementById('matchedKeywords').innerHTML = '';
}

loadResumeVersions();
</script>

</body>
</html>