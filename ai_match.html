<!doctype html>
<html lang="en">
<head>
<script>
    if (localStorage.getItem('usjobsearch_auth_v1') !== 'true') {
        window.location.href = 'index.html';
    }
</script>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>AI Job Match & Tailor</title>
<style>
  * { box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; line-height: 1.6; background: #f6f8fa; color: #24292f; margin: 0; }
  .header { background: #fff; border-bottom: 1px solid #d0d7de; padding: 16px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
  .logo { font-weight: bold; font-size: 18px; display: flex; align-items: center; gap: 8px; }
  .btn { 
    display: inline-flex; align-items: center; justify-content: center; gap: 8px; 
    padding: 8px 16px; border-radius: 6px; border: 1px solid rgba(27,31,36,0.15); 
    background-color: #f6f8fa; color: #24292f; font-size: 14px; font-weight: 600; 
    line-height: 20px; white-space: nowrap; vertical-align: middle; cursor: pointer; 
    user-select: none; appearance: none; text-decoration: none; 
    transition: 0.2s cubic-bezier(0.3, 0, 0.5, 1); 
    box-shadow: 0 1px 0 rgba(27,31,36,0.04); 
  }
  .btn:hover { background-color: #f3f4f6; text-decoration: none; transition-duration: 0.1s; }
  .btn:active { background-color: #ebecf0; box-shadow: inset 0 1px 0 rgba(208,215,222,0.2); }
  
  .btn.primary { 
    background-color: #0969da; color: #fff; border-color: rgba(27,31,36,0.15); 
    box-shadow: 0 1px 0 rgba(27,31,36,0.1); 
  }
  .btn.primary:hover { background-color: #0860ca; }
  .btn.primary:active { box-shadow: inset 0 1px 0 rgba(0,0,0,0.2); }
  .btn.primary:disabled { background-color: #80ccff; cursor: not-allowed; border-color: transparent; }
  
  .container { max-width: 1400px; margin: 0 auto; display: flex; height: calc(100vh - 65px); }
  
  /* Sidebar - Job Feed */
  .sidebar { width: 350px; background: #fff; border-right: 1px solid #d0d7de; display: flex; flex-direction: column; }
  .sidebar-header { padding: 16px; border-bottom: 1px solid #d0d7de; background: #f6f8fa; }
  .job-list { overflow-y: auto; flex: 1; }
  .job-item { padding: 16px; border-bottom: 1px solid #eaeef2; cursor: pointer; transition: background 0.2s; }
  .job-item:hover { background: #f6f8fa; }
  .job-item.active { background: #e6f7ff; border-left: 3px solid #0969da; }
  .job-title { font-weight: 600; font-size: 15px; color: #0969da; margin-bottom: 4px; }
  .job-company { font-size: 13px; color: #57606a; display: flex; justify-content: space-between; }
  .job-match-score { font-size: 12px; font-weight: bold; color: #1a7f37; background: #dafbe1; padding: 2px 6px; border-radius: 10px; }
  
  /* Main Content - Analysis */
  .main { flex: 1; display: flex; flex-direction: column; background: #fff; }
  .main-header { padding: 16px 24px; border-bottom: 1px solid #d0d7de; background: #fff; display: flex; justify-content: space-between; align-items: center; }
  .workspace { flex: 1; display: flex; overflow: hidden; }
  
  .panel { flex: 1; padding: 24px; overflow-y: auto; border-right: 1px solid #eaeef2; }
  .panel:last-child { border-right: none; }
  
  .analysis-card { background: #fff; border: 1px solid #d0d7de; border-radius: 8px; padding: 16px; margin-bottom: 16px; }
  .analysis-title { font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; font-size: 15px; }
  
  .keyword-tag { display: inline-block; padding: 4px 8px; font-size: 12px; border-radius: 4px; margin: 0 4px 4px 0; border: 1px solid transparent; }
  .keyword-missing { background: #ffebe9; color: #cf222e; border-color: #ff818266; }
  .keyword-match { background: #dafbe1; color: #1a7f37; border-color: #4ac26b66; }
  
  .tabs { display: flex; gap: 2px; border-bottom: 1px solid #d0d7de; margin-bottom: 16px; }
  .tab { padding: 8px 16px; cursor: pointer; border: 1px solid transparent; border-bottom: none; border-radius: 6px 6px 0 0; font-size: 14px; color: #57606a; }
  .tab.active { background: #fff; border-color: #d0d7de; border-bottom-color: #fff; font-weight: 600; color: #24292f; margin-bottom: -1px; }
  
  .resume-preview { font-family: "Times New Roman", serif; padding: 40px; background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.1); max-width: 800px; margin: 0 auto; min-height: 800px; font-size: 14px; line-height: 1.4; }
  .resume-preview h1 { font-size: 24px; text-align: center; text-transform: uppercase; margin-bottom: 4px; }
  .resume-preview .contact { text-align: center; font-size: 12px; margin-bottom: 20px; }
  .resume-preview h3 { border-bottom: 1px solid #000; font-size: 14px; text-transform: uppercase; margin: 16px 0 8px; padding-bottom: 2px; }
  .resume-preview .item { margin-bottom: 8px; }
  .resume-preview .row { display: flex; justify-content: space-between; font-weight: bold; }
  .resume-preview .sub { font-style: italic; font-size: 13px; }
  .resume-preview ul { margin: 4px 0 0 20px; padding: 0; }
  .resume-preview li { margin-bottom: 2px; }
  
  .highlight-new { background-color: #fff8c5; }
  
  /* Loading Overlay */
  .overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.9); z-index: 200; display: none; align-items: center; justify-content: center; flex-direction: column; }
  .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #0969da; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 16px; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  
  .empty-state { text-align: center; padding: 40px; color: #57606a; }
  
  @media print {
     @page { margin: 10mm; size: A4; }
     body { background-color: #fff; -webkit-print-color-adjust: exact; print-color-adjust: exact; overflow: visible !important; height: auto !important; }
     
     /* Hide everything by default using visibility to avoid layout issues */
     body * { visibility: hidden; }
     
     /* Only show the print area, moved to top level logically via fixed positioning/absolute */
     #printArea, #printArea * { 
       visibility: visible !important; 
     }
     
     #printArea { 
       position: absolute !important; 
       top: 0 !important; 
       left: 0 !important; 
       width: 100% !important; 
       margin: 0 !important; 
       padding: 0 !important; 
       background: white;
       overflow: visible !important;
     }
 
     /* Reset preview styles for print */
     .resume-preview { 
       width: 100% !important; 
       max-width: 100% !important; 
       margin: 0 !important; 
       padding: 0 !important; 
       box-shadow: none !important; 
       border: none !important;
     }
     
     /* Prevent page breaks inside items */
     .item, li, p { page-break-inside: avoid; }
     h1, h2, h3 { page-break-after: avoid; }
   }
</style>
</head>
<body>

<div class="header">
  <div class="logo">
    <span>ü§ñ</span> AI Job Match & Tailor
  </div>
  <div style="display:flex; gap:12px; align-items:center">
    <select id="resumeSelector" class="btn" style="min-width: 200px;" onchange="loadSelectedResume()">
      <option value="">Select Resume Version...</option>
    </select>
    <a href="index.html" class="btn">üè† Home</a>
  </div>
</div>

<div class="container">
  <!-- Sidebar: Job Feed -->
  <div class="sidebar">
    <div class="sidebar-header">
      <div style="font-weight:600; margin-bottom:8px">Daily Top 10 Matches</div>
      <div style="font-size:12px; color:#57606a">Based on your profile ‚Ä¢ <span id="todayDate"></span></div>
    </div>
    <div id="jobList" class="job-list">
      <!-- Jobs will be injected here -->
    </div>
  </div>
  
  <!-- Main Content - Analysis -->
  <div class="main">
    <div class="main-header">
      <div style="flex:1">
        <div id="activeJobTitle" style="font-weight:bold; font-size:18px">Select a job to analyze</div>
        <a id="jobLink" href="#" target="_blank" style="font-size:13px; display:none; color:#0969da; text-decoration:none; margin-top:4px; align-items:center; gap:4px">
          üîó View Original Job Posting
        </a>
      </div>
      <button class="btn primary" onclick="runTailoring()" id="tailorBtn" disabled>‚ú® Auto-Tailor Resume</button>
    </div>
    
    <div class="workspace" id="workspace" style="display:none">
      <!-- Left Panel: Analysis -->
      <div class="panel" style="flex: 0.8; background: #f6f8fa;">
        <div class="analysis-card">
          <div class="analysis-title">üìä Match Score</div>
          <div style="display:flex; align-items:center; gap:16px; margin-bottom:12px">
            <div style="font-size:32px; font-weight:bold; color:#0969da" id="scoreValue">0%</div>
            <div style="flex:1; height:8px; background:#d0d7de; border-radius:4px; overflow:hidden">
              <div id="scoreBar" style="width:0%; height:100%; background:#0969da; transition: width 1s ease"></div>
            </div>
          </div>
        </div>
        
        <div class="analysis-card">
          <div class="analysis-title">üîë Keywords Analysis</div>
          <div style="font-size:13px; color:#57606a; margin-bottom:8px">Missing High-Value Keywords:</div>
          <div id="missingKeywords"></div>
          <div style="font-size:13px; color:#57606a; margin:12px 0 8px">Matched Keywords:</div>
          <div id="matchedKeywords"></div>
        </div>

        <div class="analysis-card">
           <div class="analysis-title">üìù Job Description</div>
           <div id="jobDesc" style="font-size:13px; white-space: pre-wrap; color: #24292f; max-height: 300px; overflow-y:auto"></div>
        </div>
      </div>
      
      <!-- Right Panel: Output -->
      <div class="panel" style="flex: 1.2; padding: 0;">
        <div style="padding: 16px; border-bottom: 1px solid #d0d7de; background: #fff; display: flex; justify-content: space-between; align-items: flex-end;">
          <div class="tabs" style="margin-bottom: 0; border-bottom: none;">
            <div class="tab active" onclick="switchTab('resume')" id="tabResume">üìÑ Tailored Resume</div>
            <div class="tab" onclick="switchTab('coverletter')" id="tabCover">‚úâÔ∏è Cover Letter</div>
            <div class="tab" onclick="switchTab('networking')" id="tabNetworking">ü§ù Networking Note</div>
          </div>
          <div id="actionButtons" style="display:flex; gap:8px;">
            <!-- Buttons injected by switchTab -->
          </div>
        </div>
        
        <div id="viewResume" style="padding: 24px; background: #eef2f5; height: calc(100% - 60px); overflow-y: auto;">
          <div id="tailoredResumePreview" class="resume-preview"></div>
        </div>
        
        <div id="viewCover" style="padding: 24px; background: #eef2f5; height: calc(100% - 60px); overflow-y: auto; display:none">
          <div id="coverLetterPreview" class="resume-preview" style="white-space: pre-wrap;"></div>
        </div>

        <div id="viewNetworking" style="padding: 24px; background: #eef2f5; height: calc(100% - 60px); overflow-y: auto; display:none">
          <div id="networkingPreview" class="resume-preview" style="white-space: pre-wrap;">
             <div style="color:#57606a;text-align:center;margin-top:40px">Click "Auto-Tailor Resume" to generate networking messages.</div>
          </div>
        </div>
      </div>
    </div>
    
    <div id="emptyState" class="empty-state">
      <h3>üëà Select a job from the list to start</h3>
      <p>AI will analyze the job description and optimize your resume keywords.</p>
    </div>
  </div>
</div>

<div class="overlay" id="loadingOverlay">
  <div class="spinner"></div>
  <h3 id="loadingText">Analyzing...</h3>
  <div style="color:#57606a; font-size:14px; margin-top:8px" id="loadingSub">Extracting keywords</div>
</div>

<script>
// --- Data & State ---
let currentResume = null;
let currentJob = null;
let tailoredResumeData = null;
let tailoredCoverLetterText = "";
let networkingNoteText = "";

// --- Job Database (Expanded for diverse roles) ---
const JOB_CATEGORIES = {
  "marketing": [
    { title: "Marketing Coordinator", company: "Coca-Cola", location: "Atlanta, GA", keywords: ["Social Media", "SEO", "Content Creation", "Market Research", "Campaign Management"], desc: "Support marketing campaigns and social media strategy.", sponsor: false },
    { title: "Social Media Manager", company: "TikTok", location: "Los Angeles, CA", keywords: ["Analytics", "Community Management", "Copywriting", "Brand Strategy", "Creative"], desc: "Manage brand presence and engage with community.", sponsor: true },
    { title: "Digital Marketing Specialist", company: "HubSpot", location: "Cambridge, MA", keywords: ["SEM", "PPC", "Google Analytics", "Email Marketing", "CRM"], desc: "Optimize digital channels and drive lead generation.", sponsor: true },
    { title: "Communications Specialist", company: "Edelman", location: "New York, NY", keywords: ["Public Relations", "Press Releases", "Media Relations", "Corporate Communications", "Writing"], desc: "Draft press materials and manage media inquiries.", sponsor: false },
    { title: "Brand Ambassador", company: "Red Bull", location: "Chicago, IL", keywords: ["Event Marketing", "Customer Service", "Sales", "Networking", "Promotions"], desc: "Represent the brand at events and drive awareness.", sponsor: false },
    { title: "Content Strategist", company: "Netflix", location: "Los Gatos, CA", keywords: ["Content Strategy", "Storytelling", "Editorial", "Social Media", "Video Production"], desc: "Develop content strategies for original series.", sponsor: true },
    { title: "Product Marketing Manager", company: "Salesforce", location: "San Francisco, CA", keywords: ["GTM Strategy", "Product Launch", "Sales Enablement", "Messaging", "B2B"], desc: "Lead go-to-market strategies for new products.", sponsor: true },
    { title: "PR Coordinator", company: "Disney", location: "Burbank, CA", keywords: ["Public Relations", "Media Lists", "Events", "Press Kits", "Communication"], desc: "Assist with PR campaigns and media events.", sponsor: false }
  ],
  "business": [
    { title: "Business Analyst", company: "McKinsey & Company", location: "New York, NY", keywords: ["Data Analysis", "Excel", "PowerPoint", "Strategy", "Consulting"], desc: "Analyze business processes and recommend improvements.", sponsor: true },
    { title: "Financial Analyst", company: "Goldman Sachs", location: "New York, NY", keywords: ["Financial Modeling", "Valuation", "Accounting", "Excel", "Finance"], desc: "Conduct financial analysis and market research.", sponsor: true },
    { title: "Operations Intern", company: "Amazon", location: "Seattle, WA", keywords: ["Operations", "Logistics", "Supply Chain", "Process Improvement", "Data Analysis"], desc: "Support fulfillment center operations and efficiency.", sponsor: true },
    { title: "HR Assistant", company: "Google", location: "Mountain View, CA", keywords: ["Human Resources", "Recruiting", "Employee Relations", "Communication", "Admin"], desc: "Assist with recruitment and employee onboarding.", sponsor: true },
    { title: "Sales Representative", company: "Salesforce", location: "San Francisco, CA", keywords: ["Sales", "CRM", "Negotiation", "Lead Generation", "Communication"], desc: "Drive sales revenue and manage client relationships.", sponsor: true },
    { title: "Management Trainee", company: "Enterprise", location: "St. Louis, MO", keywords: ["Management", "Sales", "Customer Service", "Leadership", "Operations"], desc: "Learn all aspects of business management and operations.", sponsor: false }
  ],
  "design": [
    { title: "UI/UX Designer", company: "Airbnb", location: "San Francisco, CA", keywords: ["Figma", "Sketch", "Prototyping", "User Research", "Wireframing"], desc: "Design intuitive user interfaces and experiences.", sponsor: true },
    { title: "Graphic Designer", company: "Nike", location: "Beaverton, OR", keywords: ["Adobe Creative Suite", "Photoshop", "Illustrator", "Branding", "Typography"], desc: "Create visual assets for marketing campaigns.", sponsor: true },
    { title: "Product Designer", company: "Spotify", location: "New York, NY", keywords: ["Product Design", "UX", "Visual Design", "Interaction Design", "Prototyping"], desc: "Design new features for the Spotify app.", sponsor: true },
    { title: "Visual Designer", company: "Apple", location: "Cupertino, CA", keywords: ["Visual Design", "Iconography", "Sketch", "Photoshop", "Detail Oriented"], desc: "Create stunning visuals for Apple products.", sponsor: true }
  ],
  "engineering": [
    { title: "Software Engineer Intern", company: "Google", location: "Mountain View, CA", keywords: ["Python", "Java", "C++", "Data Structures", "Algorithms", "Mobile App"], desc: "Design and implement software solutions.", sponsor: true },
    { title: "Data Analyst", company: "Meta", location: "Menlo Park, CA", keywords: ["SQL", "Python", "Tableau", "PowerBI", "Data Visualization"], desc: "Analyze data to drive product decisions.", sponsor: true },
    { title: "Frontend Engineer", company: "Airbnb", location: "Remote", keywords: ["JavaScript", "TypeScript", "React", "HTML", "CSS"], desc: "Build modern web applications.", sponsor: true },
    { title: "Machine Learning Engineer", company: "OpenAI", location: "San Francisco, CA", keywords: ["Deep Learning", "PyTorch", "Python", "LLM", "AI"], desc: "Train and deploy large language models.", sponsor: true }
  ],
  "science": [
    { title: "Bioinformatics Associate", company: "Genentech", location: "South San Francisco, CA", keywords: ["Python", "R", "NGS", "Genomics", "Biology"], desc: "Analyze genomic data for drug discovery.", sponsor: true },
    { title: "Research Associate", company: "Pfizer", location: "Cambridge, MA", keywords: ["Lab Techniques", "PCR", "Cell Culture", "Data Analysis", "Biology"], desc: "Conduct experiments to support vaccine development.", sponsor: true },
    { title: "Lab Assistant", company: "University of Illinois", location: "Urbana, IL", keywords: ["Lab Safety", "Equipment Maintenance", "Data Entry", "Chemistry", "Biology"], desc: "Assist researchers with daily lab operations.", sponsor: false }
  ],
  "agtech": [
    { title: "Precision Ag Intern", company: "John Deere", location: "Champaign, IL", keywords: ["Python", "GIS", "Data Analysis", "IoT", "Sensors"], desc: "Develop software for autonomous tractors and precision agriculture.", sponsor: true },
    { title: "R&D Intern", company: "Bayer Crop Science", location: "St. Louis, MO", keywords: ["Genetics", "R", "Statistics", "Field Research", "Biology"], desc: "Support breeding pipelines and genomic research.", sponsor: true },
    { title: "Digital Ag Intern", company: "Corteva", location: "Johnston, IA", keywords: ["Remote Sensing", "Machine Learning", "Python", "Satellite Imagery"], desc: "Analyze satellite data to optimize crop yields.", sponsor: true },
    { title: "Ag Engineering Intern", company: "ADM", location: "Decatur, IL", keywords: ["Process Engineering", "AutoCAD", "Manufacturing", "Supply Chain"], desc: "Optimize food processing facilities.", sponsor: true }
  ]
};

const KEYWORD_MAPPING = {
  "marketing": ["marketing", "social media", "communication", "communications", "brand", "content", "seo", "sem", "advertising", "pr", "media", "campaign", "copywriting", "market research", "digital", "public relations", "strategic", "market", "promotion"],
  "business": ["business", "management", "finance", "consulting", "sales", "strategy", "operations", "economics", "accounting", "admin", "hr", "analyst", "project management", "entrepreneurship", "commerce"],
  "design": ["design", "ui", "ux", "graphic", "adobe", "figma", "sketch", "creative", "art", "visual", "multimedia", "animation", "illustration"],
  "engineering": ["software", "developer", "engineer", "coding", "programming", "java", "python", "c++", "react", "computer", "tech", "data", "aws", "cloud", "full stack", "backend", "frontend", "cs"],
  "science": ["biology", "chemistry", "lab", "research", "science", "genetics", "bioinformatics", "pharmaceutical", "medical", "clinical", "physics", "neuroscience", "biotech"],
  "agtech": ["ag", "agriculture", "agricultural", "crop", "farm", "soil", "food science", "nutrition", "sustainability", "environmental", "jhon deere", "bayer", "corteva"]
};

let MOCK_JOBS = []; // Will be populated dynamically

// --- Initialization ---
document.getElementById('todayDate').innerText = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
loadResumeVersions();
// renderJobs() is now called inside loadSelectedResume -> analyzeResumeAndRenderJobs

// --- Functions ---
function loadResumeVersions() {
  try {
    const versions = JSON.parse(localStorage.getItem('resume_versions') || '[]');
    const sel = document.getElementById('resumeSelector');
    if (versions.length === 0) {
      const opt = document.createElement('option');
      opt.text = "No resumes found. Create one in Builder!";
      sel.add(opt);
      sel.disabled = true;
      return;
    }
    versions.forEach((v, index) => {
      const opt = document.createElement('option');
      opt.value = index;
      opt.text = `${v.name} (${new Date(v.createdAt).toLocaleDateString()})`;
      sel.add(opt);
    });
    // Select first one by default
    sel.selectedIndex = 0; // Changed to 0 (first item)
    loadSelectedResume();
  } catch (e) {
    console.error(e);
  }
}

function loadSelectedResume() {
  const idx = document.getElementById('resumeSelector').value;
  if (idx === "") return;
  const versions = JSON.parse(localStorage.getItem('resume_versions') || '[]');
  currentResume = versions[idx].data;
  
  // Reset view
  document.getElementById('workspace').style.display = 'none';
  document.getElementById('emptyState').style.display = 'block';
  document.getElementById('tailorBtn').disabled = true;
  document.querySelectorAll('.job-item').forEach(el => el.classList.remove('active'));

  // Analyze and Render Jobs
  analyzeResumeAndRenderJobs();
}

function analyzeResumeAndRenderJobs() {
  if (!currentResume) return;

  // 1. Extract text from resume
  const resumeText = JSON.stringify(currentResume).toLowerCase();
  
  // 2. Score categories
  const scores = {};
  
  // Base keyword scoring
  for (const [category, keywords] of Object.entries(KEYWORD_MAPPING)) {
    let count = 0;
    keywords.forEach(k => {
      // Simple occurrence check
      if (resumeText.includes(k)) count++;
      // Boost if it's in the "Education" section specifically (heuristic)
      if (currentResume.edu && JSON.stringify(currentResume.edu).toLowerCase().includes(k)) {
          count += 3; // Weight education matches EVEN HIGHER
      }
    });
    scores[category] = count;
  }
  
  // 3. Determine top category
  let topCategory = "engineering"; // Default
  let maxScore = -1;
  
  console.log("Category Scores:", scores); // Debugging

  for (const [category, score] of Object.entries(scores)) {
    if (score > maxScore) {
      maxScore = score;
      topCategory = category;
    }
  }
  
  // Fallback / Override: Check major/degree explicitly
  // If the resume has education, we trust the major more than random keywords
  if (currentResume.edu && currentResume.edu.length > 0) {
      const edu = currentResume.edu[0];
      const degree = (edu.degree || "").toLowerCase();
      const major = (edu.major || "").toLowerCase();
      const combined = degree + " " + major;
      
      // Override if specific keywords are found in major/degree
      if (combined.includes('art') || combined.includes('design')) topCategory = 'design';
      else if (combined.includes('business') || combined.includes('finance') || combined.includes('econ') || combined.includes('mba') || combined.includes('commerce')) topCategory = 'business';
      else if (combined.includes('market') || combined.includes('comm') || combined.includes('public relation') || combined.includes('media') || combined.includes('advertising')) topCategory = 'marketing';
      else if (combined.includes('ag') || combined.includes('crop') || combined.includes('food') || combined.includes('env')) topCategory = 'agtech';
      else if (combined.includes('bio') || combined.includes('chem') || combined.includes('sci') || combined.includes('physics')) topCategory = 'science';
      else if (combined.includes('eng') || combined.includes('cs') || combined.includes('comp') || combined.includes('tech')) topCategory = 'engineering';
  }

  // 4. Generate Job List
  // Start with all jobs from the top category
  let jobs = [...(JOB_CATEGORIES[topCategory] || [])];
  
  // Add limited "Wildcard" jobs (max 2)
  const otherCategories = Object.keys(JOB_CATEGORIES).filter(c => c !== topCategory);
  // Shuffle other categories to get random variety
  otherCategories.sort(() => 0.5 - Math.random());
  
  // Take 1 job from first 2 random other categories
  otherCategories.slice(0, 2).forEach(c => {
    if (JOB_CATEGORIES[c] && JOB_CATEGORIES[c].length > 0) {
        jobs.push(JOB_CATEGORIES[c][0]); 
    }
  });

  // Shuffle final list
  jobs = jobs.sort(() => 0.5 - Math.random());
  
  // Limit to 10
  MOCK_JOBS = jobs.slice(0, 10).map((job, index) => ({
      ...job,
      id: index + 1
  }));
  
  // Update Header Text to show personalization
  const catTitle = topCategory.charAt(0).toUpperCase() + topCategory.slice(1);
  const dateStr = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
  
  document.querySelector('.sidebar-header').innerHTML = `
      <div style="font-weight:600; margin-bottom:8px">Daily Top 10 Matches <span style="font-size:12px;color:#0969da;background:#ddf4ff;padding:2px 6px;border-radius:10px;margin-left:4px">${catTitle} Focus</span></div>
      <div style="font-size:12px; color:#57606a">Based on your profile ‚Ä¢ ${dateStr}</div>
  `;

  renderJobs();
  
  // Show Toast
  showToast(`Jobs refreshed for ${currentResume.name || 'Resume'}!`);
}

function showToast(msg) {
    let toast = document.getElementById('toast');
    if (!toast) {
        toast = document.createElement('div');
        toast.id = 'toast';
        toast.style.cssText = 'position:fixed;bottom:20px;right:20px;background:#333;color:#fff;padding:12px 24px;border-radius:4px;z-index:1000;display:none;transition:opacity 0.3s;font-size:14px;box-shadow:0 2px 5px rgba(0,0,0,0.2);';
        document.body.appendChild(toast);
    }
    toast.innerText = msg;
    toast.style.display = 'block';
    // Trigger reflow
    void toast.offsetWidth;
    toast.style.opacity = '1';
    
    // Clear previous timeout if any
    if (toast.timeoutId) clearTimeout(toast.timeoutId);
    
    toast.timeoutId = setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.style.display = 'none', 300);
    }, 3000);
}

function renderJobs() {
  const list = document.getElementById('jobList');
  list.innerHTML = '';
  MOCK_JOBS.forEach(job => {
    const div = document.createElement('div');
    div.className = 'job-item';
    div.onclick = () => selectJob(job, div);
    
    let sponsorBadge = '';
    if (job.sponsor) {
        sponsorBadge = '<span style="font-size:10px;background:#dafbe1;color:#1a7f37;padding:1px 4px;border-radius:4px;margin-left:6px;border:1px solid rgba(26,127,55,0.2)">üá∫üá∏ Visa Friendly</span>';
    }

    div.innerHTML = `
      <div class="job-title">${job.title}${sponsorBadge}</div>
      <div class="job-company">
        <span>${job.company}</span>
        <span>${job.location}</span>
      </div>
    `;
    list.appendChild(div);
  });
}

function selectJob(job, el) {
  currentJob = job;
  // UI Update
  document.querySelectorAll('.job-item').forEach(e => e.classList.remove('active'));
  el.classList.add('active');
  
  document.getElementById('emptyState').style.display = 'none';
  document.getElementById('workspace').style.display = 'flex';
  
  let sponsorBadge = '';
  if (job.sponsor) {
      sponsorBadge = '<span style="font-size:12px;background:#dafbe1;color:#1a7f37;padding:2px 6px;border-radius:10px;margin-left:8px;vertical-align:middle;border:1px solid rgba(26,127,55,0.2)">üá∫üá∏ Visa Sponsorship Available</span>';
  }
  
  document.getElementById('activeJobTitle').innerHTML = `${job.title} @ ${job.company} ${sponsorBadge}`;
  
  // Set Job Link
  const jobLink = document.getElementById('jobLink');
  jobLink.style.display = 'inline-flex';
  // Use Google Jobs Search for best coverage
  jobLink.href = `https://www.google.com/search?q=${encodeURIComponent(job.title + " " + job.company + " careers")}&ibp=htl;jobs`;
  
  document.getElementById('tailorBtn').disabled = false;
  document.getElementById('jobDesc').innerText = job.desc;
  
  // Reset Output
  document.getElementById('viewResume').style.display = 'block';
  document.getElementById('viewCover').style.display = 'none';
  document.getElementById('tabResume').classList.add('active');
  document.getElementById('tabCover').classList.remove('active');
  document.getElementById('tailoredResumePreview').innerHTML = '<div style="color:#57606a;text-align:center;margin-top:40px">Click "Auto-Tailor Resume" to generate optimized version.</div>';
  
  tailoredResumeData = null; // Reset
  analyzeMatch();
  updateActionButtons();
}

function analyzeMatch() {
  if (!currentResume || !currentJob) return;
  
  // Simple Keyword Matching Logic
  const resumeText = JSON.stringify(currentResume).toLowerCase();
  const jobKeywords = currentJob.keywords;
  
  const matched = [];
  const missing = [];
  
  jobKeywords.forEach(k => {
    if (resumeText.includes(k.toLowerCase())) {
      matched.push(k);
    } else {
      missing.push(k);
    }
  });
  
  // Calculate Score
  const score = Math.round((matched.length / jobKeywords.length) * 100);
  
  // Update UI
  document.getElementById('scoreValue').innerText = score + '%';
  document.getElementById('scoreBar').style.width = score + '%';
  document.getElementById('scoreBar').style.background = score > 70 ? '#1a7f37' : (score > 40 ? '#d29922' : '#cf222e');
  
  const renderTags = (arr, type, containerId) => {
    const c = document.getElementById(containerId);
    c.innerHTML = '';
    if (arr.length === 0) {
      c.innerHTML = '<span style="font-size:12px;color:#57606a">None</span>';
      return;
    }
    arr.forEach(k => {
      const span = document.createElement('span');
      span.className = `keyword-tag keyword-${type}`;
      span.innerText = k;
      c.appendChild(span);
    });
  };
  
  renderTags(missing, 'missing', 'missingKeywords');
  renderTags(matched, 'match', 'matchedKeywords');
}

async function runTailoring() {
  const overlay = document.getElementById('loadingOverlay');
  const txt = document.getElementById('loadingText');
  const sub = document.getElementById('loadingSub');
  
  overlay.style.display = 'flex';
  
  // Simulation Steps
  txt.innerText = 'Analyzing Job Requirements...';
  await new Promise(r => setTimeout(r, 1000));
  
  txt.innerText = 'Optimizing Resume Structure...';
  sub.innerText = 'Injecting missing keywords: ' + document.getElementById('missingKeywords').innerText;
  await new Promise(r => setTimeout(r, 1200));
  
  txt.innerText = 'Drafting Cover Letter & Networking Note...';
  sub.innerText = 'Personalizing for ' + currentJob.company;
  await new Promise(r => setTimeout(r, 1000));
  
  overlay.style.display = 'none';
  
  generateTailoredResume();
  generateCoverLetter();
  generateNetworkingNote();
}

function generateTailoredResume() {
  // Deep copy resume
  const d = JSON.parse(JSON.stringify(currentResume));
  const missing = [];
  currentJob.keywords.forEach(k => {
     if (!JSON.stringify(d).toLowerCase().includes(k.toLowerCase())) missing.push(k);
  });
  
  // Inject keywords into Skills (Mock Tailoring)
  if (missing.length > 0) {
     d.skills.unshift({ name: "Targeted Skills (" + currentJob.company + ")", level: missing.join(', ') });
  }
  
  tailoredResumeData = d;
  
  // Render Resume (Reusing logic from resume_form.html, simplified here)
  const root = document.getElementById('tailoredResumePreview');
  root.innerHTML = '';
  
  const h1 = document.createElement('h1'); h1.innerText = d.name; root.appendChild(h1);
  const info = document.createElement('div'); info.className = 'contact'; 
  info.innerText = [d.email, d.phone, d.linkedin].filter(Boolean).join(' | '); root.appendChild(info);
  
  const addSec = (t) => { const h = document.createElement('h3'); h.innerText = t; root.appendChild(h); };
  const addRow = (l, r) => { 
     const row = document.createElement('div'); row.className='row';
     row.innerHTML = `<span>${l}</span><span>${r}</span>`;
     root.appendChild(row);
  };
  
  // Education
  if(d.edu.length) { addSec('EDUCATION'); d.edu.forEach(e => addRow(`${e.school}, ${e.city}`, `${e.degree}, ${e.period}`)); }
  
  // Experience
  if(d.exps.length) { 
    addSec('PROFESSIONAL EXPERIENCE'); 
    d.exps.forEach(e => {
        addRow(`${e.company} - ${e.title}`, e.period);
        const ul = document.createElement('ul');
        e.desc.split('\n').forEach(li => { if(li.trim()) ul.innerHTML += `<li>${li.replace(/^- /, '')}</li>`; });
        root.appendChild(ul);
    });
  }
  
  // Projects (Inject Keywords into first project description for demo)
  if(d.projects.length) {
    addSec('PROJECTS');
    d.projects.forEach((p, i) => {
        addRow(p.name, p.period);
        const ul = document.createElement('ul');
        let desc = p.desc;
        // Mock injection
        if (i === 0 && missing.length > 0) {
            desc += `\n- Optimized project using ${missing.slice(0, 3).join(', ')} to enhance performance.`;
        }
        desc.split('\n').forEach(li => { 
            if(li.trim()) {
                // Highlight injected line
                const isNew = li.includes('Optimized project using');
                ul.innerHTML += `<li class="${isNew ? 'highlight-new' : ''}">${li.replace(/^- /, '')}</li>`; 
            }
        });
        root.appendChild(ul);
    });
  }
  
  // Skills
  if(d.skills.length) {
      addSec('SKILLS');
      const div = document.createElement('div');
      d.skills.forEach(s => {
          const isNew = s.name.startsWith('Targeted');
          div.innerHTML += `<div class="${isNew ? 'highlight-new' : ''}"><b>${s.name}:</b> ${s.level}</div>`;
      });
      root.appendChild(div);
  }
}

function generateCoverLetter() {
  const d = currentResume;
  const j = currentJob;
  const today = new Date().toLocaleDateString();
  
  const text = `
${d.name}
${d.email} | ${d.phone}

${today}

Hiring Manager
${j.company}
${j.location}

Dear Hiring Manager,

I am writing to express my strong interest in the ${j.title} position at ${j.company}, as advertised. With my background in ${d.edu[0]?.major || 'Engineering'} from ${d.edu[0]?.school || 'University'}, and my hands-on experience in ${d.skills[0]?.name || 'Technology'}, I am confident in my ability to contribute effectively to your team.

I have long admired ${j.company}'s work in the industry, particularly its commitment to innovation. In my previous role at ${d.exps[0]?.company || 'my university'}, I honed my skills in ${j.keywords.slice(0,3).join(', ')}, which aligns perfectly with the requirements for this role.

Specifically, I have experience using ${j.keywords[0]} to solve complex problems, a skill I am eager to apply at ${j.company}. I am a quick learner and thrive in collaborative environments.

Thank you for considering my application. I look forward to the possibility of discussing how my skills and experiences align with the needs of your team.

Sincerely,

${d.name}
  `;
  
  document.getElementById('coverLetterPreview').innerText = text.trim();
  tailoredCoverLetterText = text.trim();
  
  // Update Buttons
  updateActionButtons();
}

function generateNetworkingNote() {
  const d = currentResume;
  const j = currentJob;
  
  // Extract a key project or skill to make it specific
  const keySkill = j.keywords[0] || "Python";
  const university = d.edu[0]?.school || "UIUC";
  const major = d.edu[0]?.major || "Engineering";

  const text = `
SUBJECT: Student Inquiry: ${j.title} role - ${d.name}

Hi [Hiring Manager Name/Alumni],

I recently came across the ${j.title} position at ${j.company} and was immediately drawn to your team's work in [mention a specific product/mission].

As a ${major} student at ${university} with experience in ${keySkill}, I believe my background aligns well with the team's needs. I recently completed a project where I [mention a relevant achievement using ${keySkill}], which I think would be relevant to the work at ${j.company}.

I would appreciate the opportunity to briefly connect and learn more about your team's current challenges. Are you open to a 10-minute chat next week?

Best regards,

${d.name}
[Link to Portfolio/LinkedIn]
  `;

  document.getElementById('networkingPreview').innerText = text.trim();
  networkingNoteText = text.trim();
}

function updateActionButtons() {
  const container = document.getElementById('actionButtons');
  container.innerHTML = '';
  
  if (!tailoredResumeData) return;
  
  const isResume = document.getElementById('tabResume').classList.contains('active');
  const isCover = document.getElementById('tabCover').classList.contains('active');
  
  if (isResume) {
     container.innerHTML = `
       <button class="btn" onclick="saveToHistory()">üíæ Save to History</button>
       <button class="btn primary" onclick="printContent('tailoredResumePreview')">üì• Download PDF</button>
     `;
   } else if (isCover) {
     container.innerHTML = `
       <button class="btn" onclick="copyText(tailoredCoverLetterText)">üìã Copy Text</button>
       <button class="btn primary" onclick="printContent('coverLetterPreview')">üì• Download PDF</button>
     `;
   } else {
     // Networking
     container.innerHTML = `
       <button class="btn primary" onclick="copyText(networkingNoteText)">üìã Copy Message</button>
     `;
   }
}

function saveToHistory() {
  if (!tailoredResumeData || !currentJob) return;
  
  const versions = JSON.parse(localStorage.getItem('resume_versions') || '[]');
  const newVersion = {
    name: `${tailoredResumeData.name} - ${currentJob.company} (Tailored)`,
    createdAt: new Date().toISOString(),
    data: tailoredResumeData
  };
  
  versions.push(newVersion);
  localStorage.setItem('resume_versions', JSON.stringify(versions));
  
  alert('Resume saved to Resume Builder History!');
  loadResumeVersions(); // Refresh dropdown
}

function printContent(elementId) {
  const content = document.getElementById(elementId);
  const originalId = content.id;
  
  // Assign ID for print media query
  content.id = 'printArea';
  window.print();
  
  // Restore ID
  content.id = originalId;
}

function copyText(text) {
  const txt = text || tailoredCoverLetterText;
  navigator.clipboard.writeText(txt).then(() => {
    alert('Content copied to clipboard!');
  });
}

function switchTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById('viewResume').style.display = 'none';
  document.getElementById('viewCover').style.display = 'none';
  document.getElementById('viewNetworking').style.display = 'none';

  if (tab === 'resume') {
    document.getElementById('tabResume').classList.add('active');
    document.getElementById('viewResume').style.display = 'block';
  } else if (tab === 'coverletter') {
    document.getElementById('tabCover').classList.add('active');
    document.getElementById('viewCover').style.display = 'block';
  } else {
    document.getElementById('tabNetworking').classList.add('active');
    document.getElementById('viewNetworking').style.display = 'block';
  }
  updateActionButtons();
}
</script>

</body>
</html>